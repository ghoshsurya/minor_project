{% extends 'base.html' %}
{% load static %}

{% block title %}Job Search - JobLift{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Search Header -->
    <div class="mb-8">
        <h2 class="text-4xl font-bold text-white mb-4">Find Your Dream Job</h2>
        <p class="text-gray-300 text-xl">Discover tailored job opportunities matched to your optimized CV</p>
    </div>
    
    <!-- Search Form -->
    <div class="bg-gray-800 shadow-xl rounded-lg mb-8">
        <div class="p-6">
            <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="md:col-span-2 relative">
                    <input type="text" name="q" id="job-search-input" placeholder="Search jobs, companies, or keywords..." class="w-full px-4 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500" value="{{ request.GET.q }}" autocomplete="off">
                    <div id="search-suggestions" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                </div>
                <div>
                    <input type="text" name="location" id="location-input" placeholder="Location" class="w-full px-4 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500" value="{{ request.GET.location }}">
                </div>
                <div>
                    <select name="job_type" class="w-full px-4 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">All Types</option>
                        <option value="full-time">Full Time</option>
                        <option value="part-time">Part Time</option>
                        <option value="contract">Contract</option>
                        <option value="remote">Remote</option>
                    </select>
                </div>
                <div>
                    <button type="submit" id="search-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-search"></i> <span id="search-text">Search</span>
                        <i class="fas fa-spinner fa-spin hidden" id="search-spinner"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Results Summary -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h5 class="text-2xl font-bold text-white">{{ total_jobs }} Live Jobs Found</h5>
            {% if query %}
            <p class="text-green-400 text-sm">Real-time results for "{{ query }}"{% if location %} in {{ location }}{% endif %}</p>
            {% endif %}
        </div>
        <div class="flex space-x-4">
            <a href="{% url 'job_scraper:alerts' %}" class="border border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-white px-4 py-2 rounded transition-colors">
                <i class="fas fa-bell mr-2"></i>Job Alerts
            </a>
            <button onclick="refreshJobs()" id="refresh-btn" class="border border-green-500 text-green-400 hover:bg-green-500 hover:text-white px-4 py-2 rounded transition-colors">
                <i class="fas fa-sync mr-2" id="refresh-icon"></i><span id="refresh-text">Refresh Jobs</span>
            </button>
        </div>
    </div>
    
    <!-- Progress Bars -->
    <div id="progress-section" class="hidden mb-8">
        <h3 class="text-xl font-bold text-white mb-4">Scraping Progress</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-slate-800/50 p-4 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-semibold">Naukri.com</span>
                    <span id="naukri-status" class="text-yellow-400">Waiting...</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="naukri-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-slate-800/50 p-4 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-semibold">Indeed.com</span>
                    <span id="indeed-status" class="text-yellow-400">Waiting...</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="indeed-progress" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-slate-800/50 p-4 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-semibold">LinkedIn</span>
                    <span id="linkedin-status" class="text-yellow-400">Waiting...</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="linkedin-progress" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-slate-800/50 p-4 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-semibold">Monster.com</span>
                    <span id="monster-status" class="text-yellow-400">Waiting...</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="monster-progress" class="bg-red-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4-Column Job Layout -->
    <div id="jobs-container" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-slate-800/50 backdrop-blur-md rounded-2xl border border-slate-600/30">
            <div class="bg-blue-600 text-white p-4 rounded-t-2xl">
                <h3 class="font-bold flex items-center">
                    <i class="fas fa-briefcase mr-2"></i>Naukri.com
                    <span id="naukri-count" class="ml-auto bg-blue-800 px-2 py-1 rounded-full text-xs">0</span>
                </h3>
            </div>
            <div id="naukri-jobs" class="p-4 space-y-4 max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-center py-8">Click refresh to load jobs</p>
            </div>
        </div>
        
        <div class="bg-slate-800/50 backdrop-blur-md rounded-2xl border border-slate-600/30">
            <div class="bg-green-600 text-white p-4 rounded-t-2xl">
                <h3 class="font-bold flex items-center">
                    <i class="fas fa-search mr-2"></i>Indeed.com
                    <span id="indeed-count" class="ml-auto bg-green-800 px-2 py-1 rounded-full text-xs">0</span>
                </h3>
            </div>
            <div id="indeed-jobs" class="p-4 space-y-4 max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-center py-8">Click refresh to load jobs</p>
            </div>
        </div>
        
        <div class="bg-slate-800/50 backdrop-blur-md rounded-2xl border border-slate-600/30">
            <div class="bg-purple-600 text-white p-4 rounded-t-2xl">
                <h3 class="font-bold flex items-center">
                    <i class="fab fa-linkedin mr-2"></i>LinkedIn
                    <span id="linkedin-count" class="ml-auto bg-purple-800 px-2 py-1 rounded-full text-xs">0</span>
                </h3>
            </div>
            <div id="linkedin-jobs" class="p-4 space-y-4 max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-center py-8">Click refresh to load jobs</p>
            </div>
        </div>
        
        <div class="bg-slate-800/50 backdrop-blur-md rounded-2xl border border-slate-600/30">
            <div class="bg-red-600 text-white p-4 rounded-t-2xl">
                <h3 class="font-bold flex items-center">
                    <i class="fas fa-monster mr-2"></i>Monster.com
                    <span id="monster-count" class="ml-auto bg-red-800 px-2 py-1 rounded-full text-xs">0</span>
                </h3>
            </div>
            <div id="monster-jobs" class="p-4 space-y-4 max-h-96 overflow-y-auto">
                <p class="text-gray-400 text-center py-8">Click refresh to load jobs</p>
            </div>
        </div>
    </div>

    <!-- History Section -->
    <div class="bg-slate-800/50 backdrop-blur-md rounded-2xl border border-slate-600/30 mb-8">
        <div class="p-4 border-b border-slate-600/30">
            <h3 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-history mr-2"></i>Previous Jobs History
                <span id="history-count" class="ml-auto bg-slate-600 px-3 py-1 rounded-full text-sm">0</span>
            </h3>
        </div>
        <div id="history-jobs" class="p-4">
            <p class="text-gray-400 text-center py-8">No previous jobs in history</p>
        </div>
    </div>
            
            <!-- Legacy Job List (Hidden) -->
            <div id="legacy-jobs" class="hidden">
            {% for job in jobs %}
            <div class="bg-slate-800/50 backdrop-blur-md p-6 rounded-2xl border-l-4 border-blue-500 mb-6 hover:bg-slate-700/50 transition-all duration-300 border border-slate-600/30">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <h5 class="text-xl font-bold mb-3 text-white">
                            <a href="{% url 'job_scraper:detail' job.id %}" class="hover:text-blue-400">
                                {{ job.title }}
                            </a>
                            <span class="bg-green-600 text-white px-2 py-1 rounded-full text-xs ml-2 animate-pulse">LIVE</span>
                        </h5>
                        <p class="text-blue-400 font-semibold mb-3">{{ job.company }}</p>
                        <p class="text-gray-300 mb-4">
                            <i class="fas fa-map-marker-alt mr-2 text-red-400"></i>{{ job.location }}
                            <span class="mx-3">•</span>
                            <i class="fas fa-briefcase mr-2 text-blue-400"></i>{{ job.job_type|title }}
                            <span class="mx-3">•</span>
                            <i class="fas fa-globe mr-2 text-green-400"></i>{{ job.portal }}
                        </p>
                        <p class="text-gray-300 mb-4">{{ job.description|truncatewords:25 }}</p>
                        <div class="flex flex-wrap gap-2">
                            <span class="bg-gray-600 text-white px-3 py-1 rounded-full text-sm">{{ job.experience_required }}</span>
                            {% if job.salary_range != 'Not disclosed' %}
                            <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">{{ job.salary_range }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="mb-4">
                            <small class="text-gray-400 block">{{ job.posted_date|timesince }} ago</small>
                            <small class="text-green-400 block font-semibold">{{ job.portal }}</small>
                        </div>
                        <a href="{{ job.job_url }}" target="_blank" class="block bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-4 py-2 rounded mb-2 text-center font-semibold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-external-link-alt mr-2"></i>Apply on {{ job.portal }}
                        </a>
                        <a href="{% url 'job_scraper:detail' job.id %}" class="block border border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-white px-4 py-2 rounded text-center">
                            View Details
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-20">
                <i class="fas fa-search text-6xl text-gray-500 mb-6"></i>
                <h4 class="text-2xl text-white mb-4">No jobs found</h4>
                <p class="text-gray-300">Try adjusting your search criteria</p>
            </div>
            {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
            <nav aria-label="Job search pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">Previous</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.location %}&location={{ request.GET.location }}{% endif %}">Last</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
        
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-gray-800 shadow-xl rounded-lg mb-6">
                <div class="p-4 border-b border-gray-700">
                    <h6 class="text-lg font-bold text-white">Top Job Portals</h6>
                </div>
                <div class="p-4">
                    {% for portal in job_portals %}
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-white">{{ portal.name }}</span>
                        <a href="{{ portal.base_url }}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="bg-gray-800 shadow-xl rounded-lg">
                <div class="p-4 border-b border-gray-700">
                    <h6 class="text-lg font-bold text-white">Quick Tips</h6>
                </div>
                <div class="p-4">
                    <ul class="space-y-3">
                        <li class="text-gray-300"><i class="fas fa-check text-green-500 mr-3"></i>Use specific keywords</li>
                        <li class="text-gray-300"><i class="fas fa-check text-green-500 mr-3"></i>Set up job alerts</li>
                        <li class="text-gray-300"><i class="fas fa-check text-green-500 mr-3"></i>Apply within 24 hours</li>
                        <li class="text-gray-300"><i class="fas fa-check text-green-500 mr-3"></i>Customize your CV</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load saved jobs on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedJobs();
});

function loadSavedJobs() {
    const savedJobs = localStorage.getItem('jobsByPortal');
    const timestamp = localStorage.getItem('jobsTimestamp');
    
    if (savedJobs && timestamp) {
        const jobsAge = Date.now() - parseInt(timestamp);
        // Load jobs if less than 1 hour old
        if (jobsAge < 3600000) {
            const jobsByPortal = JSON.parse(savedJobs);
            updatePortalColumns(jobsByPortal);
            
            const totalCount = Object.values(jobsByPortal).reduce((sum, jobs) => sum + jobs.length, 0);
            document.querySelector('h5').textContent = `${totalCount} Saved Jobs Found`;
        }
    }
}

// Real-time search functionality
let searchTimeout;
let suggestionsTimeout;
const searchInput = document.getElementById('job-search-input');
const suggestionsContainer = document.getElementById('search-suggestions');

// Popular job search terms
const popularSearches = [
    'Software Developer', 'Data Scientist', 'Product Manager', 'UI/UX Designer',
    'DevOps Engineer', 'Full Stack Developer', 'Business Analyst', 'Marketing Manager',
    'Sales Executive', 'HR Manager', 'Content Writer', 'Digital Marketing',
    'Python Developer', 'Java Developer', 'React Developer', 'Node.js Developer'
];

searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(searchTimeout);
    clearTimeout(suggestionsTimeout);
    
    if (query.length === 0) {
        hideSuggestions();
        return;
    }
    
    if (query.length >= 1) {
        suggestionsTimeout = setTimeout(() => {
            showSuggestions(query);
        }, 200);
    }
    
    if (query.length >= 3) {
        searchTimeout = setTimeout(() => {
            performRealTimeSearch(query);
        }, 800);
    }
});

searchInput.addEventListener('focus', function() {
    if (this.value.trim().length >= 1) {
        showSuggestions(this.value.trim());
    }
});

document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
        hideSuggestions();
    }
});

function showSuggestions(query) {
    const filtered = popularSearches.filter(term => 
        term.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 8);
    
    if (filtered.length === 0) {
        hideSuggestions();
        return;
    }
    
    let suggestionsHtml = '';
    filtered.forEach(suggestion => {
        const highlighted = suggestion.replace(
            new RegExp(query, 'gi'), 
            `<span class="text-blue-400 font-semibold">$&</span>`
        );
        suggestionsHtml += `
            <div class="px-4 py-3 hover:bg-gray-700 cursor-pointer border-b border-gray-600 last:border-b-0 text-white" 
                 onclick="selectSuggestion('${suggestion}')">
                <i class="fas fa-search mr-2 text-gray-400"></i>${highlighted}
            </div>
        `;
    });
    
    suggestionsContainer.innerHTML = suggestionsHtml;
    suggestionsContainer.classList.remove('hidden');
}

function hideSuggestions() {
    suggestionsContainer.classList.add('hidden');
}

function selectSuggestion(suggestion) {
    searchInput.value = suggestion;
    hideSuggestions();
    performRealTimeSearch(suggestion);
}

function performRealTimeSearch(query) {
    const location = document.getElementById('location-input').value;
    const searchBtn = document.getElementById('search-btn');
    const searchText = document.getElementById('search-text');
    const searchSpinner = document.getElementById('search-spinner');
    
    // Show loading state
    searchText.textContent = 'Searching...';
    searchSpinner.classList.remove('hidden');
    searchBtn.disabled = true;
    
    // Hide suggestions during search
    hideSuggestions();
    
    fetch(`/jobs/api/realtime-search/?q=${encodeURIComponent(query)}&location=${encodeURIComponent(location)}`)
        .then(response => response.json())
        .then(data => {
            if (data.jobs_by_portal) {
                // Move current jobs to history
                moveJobsToHistory();
                
                // Update portal columns
                updatePortalColumns(data.jobs_by_portal);
                
                // Update total count
                const totalCount = Object.values(data.jobs_by_portal).reduce((sum, jobs) => sum + jobs.length, 0);
                document.querySelector('h5').textContent = `${totalCount} Live Jobs Found`;
                
                // Show success message
                showNotification(`Found ${totalCount} real-time jobs for "${query}"`, 'success');
            } else if (data.jobs && data.jobs.length > 0) {
                // Fallback for old API format
                updateJobsList(data.jobs);
                document.querySelector('h5').textContent = `${data.jobs.length} Jobs Found`;
                showNotification(`Found ${data.jobs.length} jobs for "${query}"`, 'success');
            } else {
                showNotification('No jobs found. Try different keywords.', 'info');
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showNotification('Search failed. Please try again.', 'error');
        })
        .finally(() => {
            // Reset loading state
            searchText.textContent = 'Search';
            searchSpinner.classList.add('hidden');
            searchBtn.disabled = false;
        });
}

function updateJobsList(jobs) {
    const jobsContainer = document.querySelector('.lg\\:col-span-3');
    let jobsHtml = '';
    
    jobs.forEach(job => {
        jobsHtml += `
            <div class="bg-gray-800 p-6 rounded-lg border-l-4 border-green-500 mb-6 hover:bg-gray-750 transition-colors">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <h5 class="text-xl font-bold mb-3 text-white">
                            <span class="hover:text-blue-400">${job.title}</span>
                            <span class="bg-green-600 text-white px-2 py-1 rounded text-xs ml-2">FRESH</span>
                        </h5>
                        <p class="text-blue-400 font-semibold mb-3">${job.company}</p>
                        <p class="text-gray-300 mb-4">
                            <i class="fas fa-map-marker-alt mr-2"></i>${job.location}
                            <span class="mx-3">•</span>
                            <i class="fas fa-briefcase mr-2"></i>Full Time
                            <span class="mx-3">•</span>
                            <i class="fas fa-globe mr-2"></i>${job.portal}
                        </p>
                        <div class="flex flex-wrap gap-2">
                            <span class="bg-gray-600 text-white px-3 py-1 rounded-full text-sm">${job.experience}</span>
                            <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">${job.salary}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <small class="text-gray-400 block mb-4">Just now</small>
                        <a href="${job.url}" target="_blank" class="block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mb-2 text-center">
                            <i class="fas fa-external-link-alt mr-2"></i>Apply Now
                        </a>
                    </div>
                </div>
            </div>
        `;
    });
    
    jobsContainer.innerHTML = jobsHtml;
}

function refreshJobs() {
    const refreshBtn = document.getElementById('refresh-btn');
    const refreshIcon = document.getElementById('refresh-icon');
    const refreshText = document.getElementById('refresh-text');
    const progressSection = document.getElementById('progress-section');
    
    // Show progress section
    progressSection.classList.remove('hidden');
    
    // Reset progress bars
    const portals = ['naukri', 'indeed', 'linkedin', 'monster'];
    portals.forEach(portal => {
        document.getElementById(`${portal}-progress`).style.width = '0%';
        document.getElementById(`${portal}-status`).textContent = 'Starting...';
        document.getElementById(`${portal}-status`).className = 'text-yellow-400';
    });
    
    // Show loading state
    refreshIcon.classList.add('fa-spin');
    refreshText.textContent = 'Scraping...';
    refreshBtn.disabled = true;
    
    // Simulate progress for each portal
    let currentPortal = 0;
    const progressInterval = setInterval(() => {
        if (currentPortal < portals.length) {
            const portal = portals[currentPortal];
            document.getElementById(`${portal}-status`).textContent = 'Scraping...';
            document.getElementById(`${portal}-status`).className = 'text-blue-400';
            
            // Animate progress
            let progress = 0;
            const portalProgress = setInterval(() => {
                progress += 10;
                document.getElementById(`${portal}-progress`).style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(portalProgress);
                    document.getElementById(`${portal}-status`).textContent = 'Complete';
                    document.getElementById(`${portal}-status`).className = 'text-green-400';
                    currentPortal++;
                }
            }, 200);
        } else {
            clearInterval(progressInterval);
            // Start actual API call
            performActualRefresh();
        }
    }, 2000);
}

function performActualRefresh() {
    const query = document.getElementById('job-search-input').value || 'developer';
    const location = document.getElementById('location-input').value || 'bangalore';
    
    console.log('Starting API call with:', query, location);
    
    fetch(`/jobs/api/realtime-search/?q=${encodeURIComponent(query)}&location=${encodeURIComponent(location)}`)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            if (data.jobs_by_portal) {
                // Move current jobs to history
                moveJobsToHistory();
                
                // Update portal columns
                updatePortalColumns(data.jobs_by_portal);
                
                // Update total count
                document.querySelector('h5').textContent = `${data.total_count} Fresh Jobs Found`;
                
                showNotification(`Found ${data.total_count} real-time jobs from all portals!`, 'success');
            } else {
                console.error('No jobs_by_portal in response');
                showNotification('No jobs found in response', 'error');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showNotification('Error refreshing jobs. Please try again.', 'error');
        })
        .finally(() => {
            // Hide progress section after delay
            setTimeout(() => {
                document.getElementById('progress-section').classList.add('hidden');
            }, 2000);
            
            // Reset loading state
            document.getElementById('refresh-icon').classList.remove('fa-spin');
            document.getElementById('refresh-text').textContent = 'Refresh Jobs';
            document.getElementById('refresh-btn').disabled = false;
        });
}

function updatePortalColumns(jobsByPortal) {
    const portals = ['naukri', 'indeed', 'linkedin', 'monster'];
    
    // Save to localStorage
    localStorage.setItem('jobsByPortal', JSON.stringify(jobsByPortal));
    localStorage.setItem('jobsTimestamp', Date.now());
    
    portals.forEach(portal => {
        const jobs = jobsByPortal[portal] || [];
        const container = document.getElementById(`${portal}-jobs`);
        const countElement = document.getElementById(`${portal}-count`);
        
        countElement.textContent = jobs.length;
        
        if (jobs.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-8">No jobs found</p>';
            return;
        }
        
        let jobsHtml = '';
        jobs.forEach(job => {
            jobsHtml += `
                <div class="bg-slate-700 bg-opacity-50 p-3 rounded-lg border border-slate-600 border-opacity-30 hover:bg-slate-600 hover:bg-opacity-50 transition-all">
                    <h6 class="text-white font-semibold text-sm mb-2 line-clamp-2">${job.title}</h6>
                    <p class="text-blue-400 text-xs mb-2">${job.company}</p>
                    <p class="text-gray-300 text-xs mb-2">
                        <i class="fas fa-map-marker-alt mr-1"></i>${job.location}
                    </p>
                    <div class="flex justify-between items-center">
                        <span class="text-green-400 text-xs">${job.posted}</span>
                        <a href="${job.url}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                            Apply
                        </a>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = jobsHtml;
    });
}

function moveJobsToHistory() {
    const portals = ['naukri', 'indeed', 'linkedin', 'monster'];
    const historyContainer = document.getElementById('history-jobs');
    const historyCount = document.getElementById('history-count');
    
    let historyJobs = [];
    
    portals.forEach(portal => {
        const container = document.getElementById(`${portal}-jobs`);
        const jobs = container.querySelectorAll('div[class*="bg-slate-700"]');
        
        jobs.forEach(job => {
            const clonedJob = job.cloneNode(true);
            clonedJob.classList.add('opacity-75');
            historyJobs.push(clonedJob.outerHTML);
        });
    });
    
    if (historyJobs.length > 0) {
        historyContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                ${historyJobs.slice(0, 20).join('')}
            </div>
        `;
        historyCount.textContent = historyJobs.length;
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    } text-white`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}